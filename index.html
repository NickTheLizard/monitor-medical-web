<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Medical - Monitor Pacien»õi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        // Func»õie de debugging pentru conexiune API (corectatƒÉ)
        async function debugApiConnection() {
            console.log('üîß √éNCEPERE DEBUG CONEXIUNE API');
            showMessage('üîç Rulare teste de debugging...', 'info');
            
            const apiUrl = document.getElementById('api-url').value.trim();
            
            // Test 1: Ping simplu fƒÉrƒÉ headers care cauzeazƒÉ CORS
            console.log('üì° Test 1: Ping la URL de bazƒÉ...');
            try {
                const pingResponse = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'no-cors', // Bypass CORS pentru test
                    signal: AbortSignal.timeout(5000)
                });
                console.log(`‚úÖ Ping reu»ôit: ${pingResponse.status || 'opaque response'}`);
                showMessage('‚úÖ Serverul rƒÉspunde, dar CORS nu e configurat corect', 'warning');
            } catch (error) {
                console.error(`‚ùå Ping e»ôuat:`, error);
                showMessage(`‚ùå Ping la ${apiUrl} a e»ôuat: ${error.message}`, 'error');
                return;
            }
            
            // Test 2: VerificƒÉ CORS pentru fiecare endpoint
            const endpoints = [
                'get_pacienti.php',
                'login_medic.php', 
                'get_masuratori.php'
            ];
            
            for (let endpoint of endpoints) {
                console.log(`üì° Test CORS endpoint: ${endpoint}`);
                try {
                    const testResponse = await fetch(`${apiUrl}/${endpoint}`, {
                        method: 'OPTIONS', // Preflight request
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    console.log(`üìä ${endpoint} CORS: ${testResponse.status}`);
                    
                    if (testResponse.status === 404) {
                        showMessage(`‚ùå ${endpoint} nu existƒÉ pe server (404)`, 'error');
                    } else if (testResponse.ok || testResponse.status === 405) {
                        showMessage(`‚úÖ ${endpoint} existƒÉ, dar CORS lipse»ôte`, 'warning');
                    }
                } catch (error) {
                    console.error(`‚ùå Eroare CORS ${endpoint}:`, error);
                    showMessage(`‚ùå ${endpoint}: CORS blocat`, 'error');
                }
            }
            
            // Mesaj final cu instruc»õiuni pentru coleg
            showMessage(`
üö´ PROBLEMA IDENTIFICATƒÇ: CORS nu e configurat in PHP!

Spune colegului sƒÉ adauge √Æn TOATE fi»ôierele PHP (.php):

<?php
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, ngrok-skip-browser-warning");

if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    http_response_code(200);
    exit();
}
// ... restul codului PHP
?>

Apoi sƒÉ reporneascƒÉ XAMPP »ôi sƒÉ testeze din nou.
            `, 'error');
            
            console.log('üîß FINALIZARE DEBUG CONEXIUNE API');
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5282;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .doctor-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doctor-details h3 {
            color: #2c5282;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .logout-btn {
            background: #e53e3e;
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
        }

        .patients-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .patients-list h3 {
            color: #2c5282;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
        }

        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .patient-item:hover {
            border-color: #2c5282;
            background: #f0f4f8;
            transform: translateY(-2px);
        }

        .patient-item.selected {
            border-color: #2c5282;
            background: #e6f3ff;
        }

        .patient-info {
            flex-grow: 1;
        }

        .patient-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .patient-details {
            color: #666;
            font-size: 0.95em;
        }

        .patient-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .alert-normal {
            background: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }

        .alert-warning {
            background: #ed8936;
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            animation: pulse-warning 2s infinite;
        }

        .alert-critical {
            background: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            animation: pulse-critical 1s infinite;
        }

        .alert-offline {
            background: #a0aec0;
            box-shadow: 0 0 0 3px rgba(160, 174, 192, 0.2);
        }

        @keyframes pulse-warning {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 6px rgba(237, 137, 54, 0.4);
            }
        }

        @keyframes pulse-critical {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px rgba(229, 62, 62, 0.6);
            }
        }

        .patient-values {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .patient-values.active {
            display: block;
        }

        .patient-values h4 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .value-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .ecg-item {
            grid-column: span 2;
            text-align: left;
        }

        .ecg-container {
            background: #000;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            position: relative;
        }

        #ecg-canvas {
            width: 100%;
            height: 120px;
            display: block;
        }

        .ecg-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .ecg-bpm {
            font-weight: bold;
            font-size: 16px;
        }

        .ecg-rhythm {
            font-style: italic;
        }

        .value-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .value-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
        }

        .value-status {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .status-normal { background: #c6f6d5; color: #22543d; }
        .status-warning { background: #feebc8; color: #c05621; }
        .status-critical { background: #fed7d7; color: #c53030; }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fc8181;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #9ae6b4;
        }

        .info {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #63b3ed;
        }

        .last-update {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-disconnected {
            background: #fed7d7;
            color: #c53030;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">üîå Verificare conexiune...</div>

    <div class="container">
        <div class="header">
            <h1>‚öïÔ∏è Portal Medical</h1>
            <p>Monitor pacien»õi √Æn timp real</p>
        </div>

        <!-- Configurare API -->
        <div id="config-section" class="config-section">
            <h3>‚öôÔ∏è Conexiune la API-ul PHP (XAMPP + ngrok)</h3>
            <p style="margin-bottom: 15px; color: #856404;">
                <strong>‚úÖ API-ul colegului (PHP/XAMPP):</strong> <code>https://fcc8-2a02-2f09-3c02-b600-f14c-834e-2af7-60da.ngrok-free.app</code><br>
                Endpoint-uri disponibile: <code>/login_medic.php</code>, <code>/get_pacienti.php</code>, <code>/get_masuratori.php</code>
            </p>
            <input type="text" id="api-url" class="config-input" 
                   placeholder="URL API actualizat de coleg"
                   value="https://fcc8-2a02-2f09-3c02-b600-f14c-834e-2af7-60da.ngrok-free.app">
            <button class="btn btn-small" onclick="saveApiConfig()">TesteazƒÉ conexiunea</button>
            
            <!-- Buton pentru debugging detaliat -->
            <button class="btn btn-small" onclick="debugApiConnection()" 
                    style="background: #e53e3e; margin-left: 10px;">
                üîç Debug conexiune
            </button>
        </div>

        <!-- Mesaje -->
        <div id="messages"></div>

        <!-- Sec»õiunea de autentificare pentru medici -->
        <div id="auth-section" class="auth-section">
            <div class="login-form">
                <h2>ü©∫ Autentificare Medic</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-id">ID Medic:</label>
                        <input type="number" id="login-id" placeholder="ID-ul medicului (ex: 1)" 
                               value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">ParolƒÉ:</label>
                        <input type="password" id="login-password" placeholder="Parola ta" 
                               value="popescu123" required>
                    </div>
                    <button type="submit" class="btn">Acces Portal Medical</button>
                    
                    <!-- Buton pentru demonstra»õie -->
                    <button type="button" class="btn" onclick="demoMode()" 
                            style="background: #38a169; margin-top: 10px;">
                        üé¨ DEMO - Vezi aplica»õia fƒÉrƒÉ login
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard-ul pentru medici -->
        <div id="dashboard" class="dashboard">
            <!-- Informa»õii medic -->
            <div class="doctor-info">
                <div class="doctor-details">
                    <h3>Dr. <span id="doctor-name">Nume Doctor</span></h3>
                    <p><strong>Email:</strong> <span id="doctor-email">doctor@spital.ro</span></p>
                </div>
                <button class="btn logout-btn" onclick="logout()">Deconectare</button>
            </div>

            <!-- Lista pacien»õilor -->
            <div class="patients-list">
                <h3>üìã Lista Pacien»õi</h3>
                
                <!-- Legenda pentru bulinu»õe -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.9em;">
                    <strong>üîç Legenda alertelor:</strong><br>
                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                        <div style="width: 12px; height: 12px; background: #48bb78; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Toate parametrii normali</span>
                    </span>
                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                        <div style="width: 12px; height: 12px; background: #ed8936; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Cel pu»õin un parametru la limitƒÉ</span>
                    </span>
                    <span style="display: inline-flex; align-items: center;">
                        <div style="width: 12px; height: 12px; background: #e53e3e; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Cel pu»õin un parametru critic</span>
                    </span>
                </div>
                
                <div id="patients-container">
                    <div class="info">
                        üì° Se √ÆncearcƒÉ conectarea la API pentru √ÆncƒÉrcarea pacien»õilor...
                    </div>
                </div>
            </div>

            <!-- Detalii pacient selectat -->
            <div id="patient-values" class="patient-values">
                <h4>MƒÉsurƒÉtori pentru: <span id="selected-patient-name">-</span></h4>
                <div class="values-grid">
                    <div class="value-item">
                        <div class="value-label">TemperaturƒÉ</div>
                        <div class="value-number" id="temp-value">--¬∞C</div>
                        <div class="value-status status-normal" id="temp-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Puls</div>
                        <div class="value-number" id="pulse-value">-- BPM</div>
                        <div class="value-status status-normal" id="pulse-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Satura»õia O2</div>
                        <div class="value-number" id="oxygen-value">--%</div>
                        <div class="value-status status-normal" id="oxygen-status">-</div>
                    </div>
                    <div class="value-item ecg-item">
                        <div class="value-label">ElectrocardiogramƒÉ (ECG)</div>
                        <div class="ecg-container">
                            <canvas id="ecg-canvas" width="300" height="120"></canvas>
                            <div class="ecg-info">
                                <span class="ecg-bpm" id="ecg-bpm">75 BPM</span>
                                <span class="ecg-rhythm" id="ecg-rhythm">Ritm sinusal normal</span>
                            </div>
                        </div>
                        <div class="value-status status-normal" id="ecg-status">Normal</div>
                    </div>
                </div>
            </div>

            <div class="last-update">
                Ultima actualizare: <span id="last-update">-</span>
            </div>
        </div>
    </div>

    <script>
        // üìÅ Configura»õie API PHP
        let API_BASE_URL = "https://fcc8-2a02-2f09-3c02-b600-f14c-834e-2af7-60da.ngrok-free.app";
        let authToken = localStorage.getItem('authToken');
        let currentDoctor = JSON.parse(localStorage.getItem('currentDoctor') || '{}');
        let selectedPatientId = null;
        let updateInterval = null;
        let isApiConnected = false;

        // Variabile pentru ECG √Æn timp real
        let ecgCanvas = null;
        let ecgCtx = null;
        let ecgDataBuffer = [];
        let ecgAnimation = null;
        let ecgTime = 0;
        let maxECGBufferSize = 500;
        let ecgSampleRate = 100;
        let isReceivingRealECG = false;

        // üîê Login medic folosind API-ul PHP
        async function apiLoginPHP(idMedic, parola) {
            try {
                const response = await fetch(`${API_BASE_URL}/login_medic.php`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ id_medic: parseInt(idMedic), parola: parola }),
                });
                
                const data = await response.json();
                console.log('RƒÉspuns login PHP:', data);
                return data;
            } catch (error) {
                console.error('Eroare API login PHP:', error);
                throw error;
            }
        }

        // üìã Lista pacien»õilor din API-ul PHP
        async function getPacientiPHP() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_pacienti.php`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    }
                });
                
                const data = await response.json();
                console.log('RƒÉspuns pacienti PHP:', data);
                return data;
            } catch (error) {
                console.error('Eroare API pacienti PHP:', error);
                throw error;
            }
        }

        // üìä MƒÉsurƒÉtori pentru pacient din API-ul PHP  
        async function getMasuratori_PHP(idPacient) {
            try {
                const response = await fetch(`${API_BASE_URL}/get_masuratori.php`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json", 
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ id_pacient: parseInt(idPacient) })
                });
                
                const data = await response.json();
                console.log('RƒÉspuns masuratori PHP pentru pacient', idPacient, ':', data);
                return data;
            } catch (error) {
                console.error('Eroare API masuratori PHP:', error);
                throw error;
            }
        }

        // Ini»õializare c√¢nd se √ÆncarcƒÉ aplica»õia
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-url').value = API_BASE_URL;
            testApiConnection();
            
            if (authToken) {
                showDashboard();
            }
        });

        // Salvare configurare API
        function saveApiConfig() {
            const apiUrl = document.getElementById('api-url').value.trim();
            if (!apiUrl) {
                showMessage('Te rog introdu URL-ul API-ului!', 'error');
                return;
            }
            
            // EliminƒÉ slash-ul final dacƒÉ existƒÉ
            API_BASE_URL = apiUrl.replace(/\/$/, '');
            localStorage.setItem('api_base_url', API_BASE_URL);
            
            showMessage('Configurare salvatƒÉ! Se testeazƒÉ conexiunea...', 'info');
            testApiConnection();
        }

        // Test conexiune API PHP (√ÆmbunƒÉtƒÉ»õit cu debugging)
        async function testApiConnection() {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = 'üîÑ Testare conexiune...';
            statusElement.className = 'connection-status';
            
            console.log(`üîç Testare conexiune la: ${API_BASE_URL}`);
            
            try {
                // Test 1: VerificƒÉ dacƒÉ rƒÉspunde la cerere simplƒÉ
                console.log('Test 1: Cerere GET simplƒÉ...');
                const response = await fetch(`${API_BASE_URL}/get_pacienti.php`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    signal: AbortSignal.timeout(10000) // timeout 10 secunde
                });
                
                console.log('üìä Status rƒÉspuns:', response.status);
                console.log('üìä Headers rƒÉspuns:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const contentType = response.headers.get('content-type');
                    console.log('üìä Content-Type:', contentType);
                    
                    // √éncearcƒÉ sƒÉ citeascƒÉ rƒÉspunsul
                    const responseText = await response.text();
                    console.log('üìä RƒÉspuns complet:', responseText);
                    
                    // VerificƒÉ dacƒÉ e JSON valid
                    try {
                        const jsonData = JSON.parse(responseText);
                        console.log('‚úÖ JSON valid primit:', jsonData);
                        
                        isApiConnected = true;
                        statusElement.textContent = '‚úÖ API PHP conectat';
                        statusElement.className = 'connection-status status-connected';
                        document.getElementById('config-section').style.display = 'none';
                        showMessage('API PHP conectat cu succes! Endpoint-ul /get_pacienti.php rƒÉspunde.', 'success');
                    } catch (jsonError) {
                        console.error('‚ùå RƒÉspunsul nu e JSON valid:', jsonError);
                        throw new Error(`API rƒÉspunde cu HTML √Æn loc de JSON. RƒÉspuns: ${responseText.substring(0, 200)}`);
                    }
                } else if (response.status === 404) {
                    console.log('üìä Status 404 - endpoint nu existƒÉ');
                    throw new Error(`Endpoint /get_pacienti.php nu existƒÉ (404). VerificƒÉ cƒÉ fi»ôierul e √Æn htdocs.`);
                } else {
                    console.log('üìä Status nea»ôteptat:', response.status);
                    const errorText = await response.text();
                    console.log('üìä Mesaj eroare:', errorText);
                    throw new Error(`API rƒÉspunde cu status ${response.status}: ${errorText.substring(0, 100)}`);
                }
            } catch (error) {
                isApiConnected = false;
                statusElement.textContent = '‚ùå API deconectat';
                statusElement.className = 'connection-status status-disconnected';
                document.getElementById('config-section').style.display = 'block';
                
                console.error('‚ùå Eroare completƒÉ conexiune:', error);
                
                // Mesaj de eroare mai detaliat
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showMessage(`üö´ EROARE CORS - Serverul PHP nu permite cereri cross-origin!
                    
SOLU»öIE pentru coleg:
1. AdaugƒÉ √Æn TOATE fi»ôierele PHP (.php):

<?php
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, ngrok-skip-browser-warning");

if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    http_response_code(200);
    exit();
}
// ... restul codului existent
?>

2. Reporne»ôte XAMPP (Stop + Start Apache)
3. TesteazƒÉ din nou aplica»õia`, 'error');
                } else if (error.name === 'AbortError') {
                    showMessage(`‚è±Ô∏è Timeout - serverul nu rƒÉspunde √Æn 10 secunde. 
                    
VerificƒÉ:
1. Conexiunea la internet
2. ngrok ruleazƒÉ corect
3. XAMPP proceseazƒÉ cererile`, 'error');
                } else {
                    showMessage(`‚ùå Eroare conexiune: ${error.message}`, 'error');
                }
            }
        }

        // Func»õie pentru afi»ôarea mesajelor
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Gestionare login adaptat pentru API-ul PHP
        async function handleLogin(event) {
            event.preventDefault();
            
            const idMedic = document.getElementById('login-id').value;
            const parola = document.getElementById('login-password').value;

            if (!idMedic || !parola) {
                showMessage('Te rog completeazƒÉ ID-ul medicului »ôi parola!', 'error');
                return;
            }

            try {
                showMessage('Se √ÆncearcƒÉ conectarea la API-ul PHP...', 'info');
                
                const loginResult = await apiLoginPHP(idMedic, parola);
                console.log('Rezultat login:', loginResult);
                
                if (loginResult.success && loginResult.medic) {
                    // Login reu»ôit
                    authToken = `php_token_${loginResult.medic.id}_${Date.now()}`;
                    currentDoctor = {
                        id: loginResult.medic.id,
                        nume: `Dr. ${loginResult.medic.nume} ${loginResult.medic.prenume}`,
                        email: loginResult.medic.email,
                        prenume: loginResult.medic.prenume,
                        nume_familie: loginResult.medic.nume
                    };
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentDoctor', JSON.stringify(currentDoctor));
                    
                    showMessage('Autentificare reu»ôitƒÉ √Æn API-ul PHP!', 'success');
                    showDashboard();
                } else {
                    throw new Error(loginResult.message || 'Date de autentificare incorecte');
                }
            } catch (error) {
                console.error('Eroare completƒÉ login:', error);
                showMessage(`Eroare de conectare: ${error.message}. VerificƒÉ ID-ul »ôi parola.`, 'error');
            }
        }

        // Afi»ôare dashboard pentru medici
        async function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('config-section').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            // ActualizeazƒÉ informa»õiile medicului
            document.getElementById('doctor-name').textContent = currentDoctor.nume || 'Doctor';
            document.getElementById('doctor-email').textContent = currentDoctor.email || 'doctor@spital.ro';
            
            // √éncarcƒÉ lista pacien»õilor
            await loadPatientsPHP();
            
            // Ini»õializeazƒÉ ECG canvas
            initializeECG();
            
            // Porne»ôte actualizarea automatƒÉ
            startMonitoring();
        }

        // √éncƒÉrcare lista pacien»õilor din API-ul PHP
        async function loadPatientsPHP() {
            try {
                showMessage('Se √ÆncarcƒÉ pacien»õii din API-ul PHP...', 'info');
                
                const pacientiResult = await getPacientiPHP();
                console.log('Rezultat pacienti:', pacientiResult);
                
                if (pacientiResult.success && pacientiResult.pacienti) {
                    const patients = pacientiResult.pacienti;
                    
                    // AdapteazƒÉ structura pentru interfa»õƒÉ (conform SQL)
                    const adaptedPatients = patients.map(patient => ({
                        id_pacient: patient.id_pacient,
                        nume: patient.nume || 'Necunoscut',
                        prenume: patient.prenume || 'Pacient',
                        email: patient.email || 'N/A',
                        telefon: patient.telefon || 'N/A',
                        data_nasterii: patient.data_nasterii || 'N/A',
                        // GenereazƒÉ camera »ôi diagnostic pentru afi»ôare (nu sunt √Æn tabela SQL)
                        camera: `Camera ${patient.id_pacient + 100}`,
                        diagnostic: 'Monitorizare medicalƒÉ'
                    }));
                    
                    displayPatients(adaptedPatients);
                    showMessage(`${adaptedPatients.length} pacien»õi √ÆncƒÉrca»õi din baza de date MySQL`, 'success');
                } else {
                    throw new Error('Nu s-au putut √ÆncƒÉrca pacien»õii din API');
                }
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea pacien»õilor:', error);
                
                // Fallback la pacien»õii din SQL pentru demo
                const sqlPatients = [
                    { 
                        id_pacient: 1, 
                        nume: 'Caraba', 
                        prenume: 'Dragos', 
                        email: 'dragoscaraba@yahoo.com',
                        telefon: '075503019',
                        data_nasterii: '2000-12-02',
                        camera: '101', 
                        diagnostic: 'Monitorizare cardiacƒÉ - senzori activi' 
                    },
                    { 
                        id_pacient: 2, 
                        nume: 'Damian', 
                        prenume: 'Daniel', 
                        email: 'daniel.damian@yahoo.com',
                        telefon: '0745627899', 
                        data_nasterii: '1982-12-02',
                        camera: '102', 
                        diagnostic: 'Monitorizare post-operatorie' 
                    }
                ];
                displayPatients(sqlPatients);
                showMessage('Folosind pacien»õii din baza de date SQL pentru demo', 'info');
            }
        }

        // Afi»ôare lista pacien»õilor √Æn interfa»õƒÉ
        function displayPatients(patients) {
            const container = document.getElementById('patients-container');
            
            if (!patients || patients.length === 0) {
                container.innerHTML = `
                    <div class="info">
                        üìã Nu sunt pacien»õi √Ænregistra»õi √Æn sistem.
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            patients.forEach(patient => {
                const patientElement = document.createElement('div');
                patientElement.className = 'patient-item';
                patientElement.onclick = () => selectPatient(
                    patient.id_pacient || patient.id, 
                    `${patient.prenume} ${patient.nume}`
                );
                
                patientElement.innerHTML = `
                    <div class="patient-info">
                        <div class="patient-name">${patient.prenume} ${patient.nume}</div>
                        <div class="patient-details">
                            üìß ${patient.email || 'N/A'} | 
                            üè• Camera ${patient.camera || 'N/A'} | 
                            üìã ${patient.diagnostic || 'Monitorizare generalƒÉ'}
                        </div>
                    </div>
                    <div class="patient-status">
                        <div class="alert-indicator alert-offline" id="alert-${patient.id_pacient || patient.id}"></div>
                    </div>
                `;
                
                container.appendChild(patientElement);
            });
        }

        // Selectare pacient (√ÆmbunƒÉtƒÉ»õitƒÉ pentru API PHP)
        function selectPatient(patientId, patientName) {
            console.log(`Selectare pacient: ${patientId} - ${patientName}`);
            
            // EliminƒÉ selec»õia anterioarƒÉ
            document.querySelectorAll('.patient-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // SelecteazƒÉ pacientul curent
            event.target.closest('.patient-item').classList.add('selected');
            
            selectedPatientId = patientId;
            document.getElementById('selected-patient-name').textContent = patientName;
            document.getElementById('patient-values').classList.add('active');
            
            // ActualizeazƒÉ imediat mƒÉsurƒÉtorile pentru pacientul selectat
            setTimeout(async () => {
                const measurements = await getPatientMeasurementsPHP(patientId);
                updateSelectedPatientValues(measurements);
                
                // Reini»õializeazƒÉ ECG pentru noul pacient
                if (ecgAnimation) {
                    cancelAnimationFrame(ecgAnimation);
                }
                initializeECG();
            }, 100);
        }

        // Ob»õinere mƒÉsurƒÉtori folosind API-ul PHP
        async function getPatientMeasurementsPHP(patientId) {
            console.log(`Ob»õinere mƒÉsurƒÉtori PHP pentru pacientul ${patientId}`);
            
            try {
                // √én mod demo, returneazƒÉ √Æntotdeauna date simulate
                if (authToken && authToken.includes('demo_token')) {
                    const measurements = generateSimulatedData(patientId);
                    console.log(`Date simulate generate pentru ${patientId}:`, measurements);
                    return measurements;
                }
                
                // Folose»ôte API-ul PHP real
                const masuratori = await getMasuratori_PHP(patientId);
                console.log(`MƒÉsurƒÉtori din API-ul PHP pentru pacientul ${patientId}:`, masuratori);
                
                if (masuratori.success && masuratori.masuratori && masuratori.masuratori.length > 0) {
                    // Ia ultima mƒÉsurƒÉtoare din lista primitƒÉ
                    const latestMeasurement = masuratori.masuratori[masuratori.masuratori.length - 1];
                    
                    // AdapteazƒÉ formatul pentru interfa»õƒÉ (conform coloanelor SQL)
                    return {
                        temperatura: latestMeasurement.temperatura || '24.4', // Valorile din SQL sunt cam mici (24¬∞C)
                        puls: latestMeasurement.puls || '75',
                        umiditate: latestMeasurement.umiditate || '42', // Umiditatea din SQL
                        ecg: latestMeasurement.ecg || '2', // Valorile ECG din SQL
                        timestamp: latestMeasurement.timestamp || new Date().toLocaleString('ro-RO'),
                        // GenereazƒÉ date ECG simulate pentru acum
                        ecgRealTime: {
                            rawData: generateECGPoints(),
                            heartRate: parseInt(latestMeasurement.puls || 75),
                            rhythm: 'normal'
                        }
                    };
                } else {
                    console.log('Nu sunt mƒÉsurƒÉtori √Æn API, folosesc date simulate');
                    throw new Error('Nu sunt mƒÉsurƒÉtori disponibile');
                }
            } catch (error) {
                console.error('Eroare mƒÉsurƒÉtori PHP:', error);
                
                // Fallback la date simulate
                const measurements = generateSimulatedData(patientId);
                console.log(`Fallback la date simulate pentru ${patientId}:`, measurements);
                return measurements;
            }
        }

        // Deconectare
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentDoctor');
            authToken = null;
            currentDoctor = {};
            selectedPatientId = null;
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('patient-values').classList.remove('active');
            showMessage('A»õi fost deconectat din portal.', 'success');
        }

        // Porne»ôte monitorizarea automatƒÉ
        function startMonitoring() {
            console.log('Pornire monitorizare...');
            
            // Opre»ôte intervalul anterior dacƒÉ existƒÉ
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Prima actualizare imediatƒÉ
            updatePatientsStatus();
            
            // Actualizare la fiecare 5 secunde
            updateInterval = setInterval(() => {
                console.log('Actualizare automatƒÉ...');
                updatePatientsStatus();
            }, 5000);
        }

        // Actualizare statusuri pacien»õi
        async function updatePatientsStatus() {
            if (!isApiConnected) return;
            
            try {
                const patientElements = document.querySelectorAll('.patient-item');
                
                for (let element of patientElements) {
                    const alertElement = element.querySelector('.alert-indicator');
                    const patientId = alertElement.id.replace('alert-', '');
                    
                    const measurements = await getPatientMeasurementsPHP(patientId);
                    updatePatientAlert(patientId, measurements);
                    
                    // DacƒÉ este pacientul selectat, actualizeazƒÉ valorile
                    if (selectedPatientId == patientId) {
                        updateSelectedPatientValues(measurements);
                    }
                }
                
                document.getElementById('last-update').textContent = new Date().toLocaleString('ro-RO');
            } catch (error) {
                console.error('Eroare la actualizarea statusului:', error);
            }
        }

        // Actualizare bulinu»õƒÉ alertƒÉ pentru un pacient (adaptatƒÉ pentru datele SQL)
        function updatePatientAlert(patientId, measurements) {
            const alertElement = document.getElementById(`alert-${patientId}`);
            if (!alertElement) return;

            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const umiditate = parseInt(measurements.umiditate || 42);

            // Logica pentru determinarea tipului de alertƒÉ (adaptatƒÉ pentru valorile din SQL)
            let alertType = 'normal';
            
            // Valori critice (adaptate pentru valorile din SQL care sunt √Æn jur de 24¬∞C)
            if (temp > 26.0 || temp < 22.0 || puls > 120 || puls < 50 || umiditate < 35) {
                alertType = 'critical';
            }
            // Valori de aten»õionare
            else if (temp > 25.0 || temp < 23.0 || puls > 100 || puls < 60 || umiditate < 40) {
                alertType = 'warning';
            }

            // ActualizeazƒÉ clasa bulinu»õei
            alertElement.className = `alert-indicator alert-${alertType}`;
        }

        // Actualizare valori pentru pacientul selectat (adaptat pentru datele SQL)
        function updateSelectedPatientValues(measurements) {
            document.getElementById('temp-value').textContent = `${measurements.temperatura}¬∞C`;
            document.getElementById('pulse-value').textContent = `${measurements.puls} BPM`;
            document.getElementById('oxygen-value').textContent = `${measurements.umiditate}%`; // Folosim umiditatea ca »ôi satura»õie O2 pentru demo
            
            // SchimbƒÉ eticheta pentru claritate
            document.querySelector('.value-item:nth-child(3) .value-label').textContent = 'Umiditate (%)';

            // ActualizeazƒÉ statusurile (adaptate pentru valorile din SQL)
            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const umiditate = parseInt(measurements.umiditate);

            // AjusteazƒÉ pragurile pentru valorile din SQL (temperatura e √Æn jur de 24¬∞C √Æn SQL)
            updateValueStatus('temp', temp, [23.0, 25.0], [22.0, 26.0]); // Praguri adaptate
            updateValueStatus('pulse', puls, [60, 100], [50, 120]);
            updateValueStatus('oxygen', umiditate, [40, 50], [35, 55]); // Praguri pentru umiditate
            
            // ECG-ul se actualizeazƒÉ automat prin anima»õie
        }

        // Actualizare status pentru o valoare specificƒÉ
        function updateValueStatus(prefix, value, normalRange, criticalRange) {
            const statusElement = document.getElementById(`${prefix}-status`);
            
            if (value < criticalRange[0] || value > criticalRange[1]) {
                statusElement.textContent = 'CRITIC';
                statusElement.className = 'value-status status-critical';
            } else if (value < normalRange[0] || value > normalRange[1]) {
                statusElement.textContent = 'Aten»õie';
                statusElement.className = 'value-status status-warning';
            } else {
                statusElement.textContent = 'Normal';
                statusElement.className = 'value-status status-normal';
            }
        }

        // Mod demonstra»õie - sare peste login
        function demoMode() {
            // SimuleazƒÉ un doctor logat
            currentDoctor = {
                id: 1,
                nume: 'Dr. Demo',
                email: 'demo@spital.ro'
            };
            
            authToken = 'demo_token_123';
            
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentDoctor', JSON.stringify(currentDoctor));
            
            showMessage('Mod demonstra»õie activat! Toate datele sunt simulate.', 'success');
            showDashboard();
            
            // For»õeazƒÉ pornirea monitorizƒÉrii dupƒÉ o secundƒÉ
            setTimeout(() => {
                console.log('Pornire monitorizare for»õatƒÉ...');
                startMonitoring();
            }, 1000);
        }

        // Generare date simulate pentru demonstra»õie (adaptate pentru datele din SQL)
        function generateSimulatedData(patientId) {
            const patientProfiles = {
                1: { // Caraba Dragos - Date reale din SQL: temp ~24¬∞C, puls variabil, umiditate ~42%
                    name: "Caraba Dragos",
                    condition: "Monitorizare cardiacƒÉ cu senzori",
                    temp: { base: 24.4, variation: 0.3 }, // Bazat pe datele SQL
                    puls: { base: 85, variation: 20 }, // Valorile din SQL variazƒÉ mult
                    umiditate: { base: 42, variation: 2 }, // Din SQL
                    ecg: { base: 2.5, variation: 1.5, anomaly: false } // Valorile ECG din SQL sunt mici
                },
                2: { // Damian Daniel - Pacient stabil
                    name: "Damian Daniel", 
                    condition: "Monitorizare post-operatorie",
                    temp: { base: 24.2, variation: 0.2 },
                    puls: { base: 72, variation: 8 },
                    umiditate: { base: 43, variation: 1 },
                    ecg: { base: 1.8, variation: 0.5, anomaly: false }
                }
            };

            const profile = patientProfiles[patientId] || patientProfiles[1];
            
            // Generare valori cu varia»õii realiste
            const temp = profile.temp.base + (Math.random() - 0.5) * profile.temp.variation;
            const puls = Math.round(profile.puls.base + (Math.random() - 0.5) * profile.puls.variation);
            const umiditate = Math.round(profile.umiditate.base + (Math.random() - 0.5) * profile.umiditate.variation);
            
            // Simulare deteriorare/√ÆmbunƒÉtƒÉ»õire √Æn timp
            const timeVariation = Math.sin(Date.now() / 30000) * 0.1;
            
            // Generare puncte ECG simulate
            const ecgPoints = [];
            for (let i = 0; i < 10; i++) {
                const point = profile.ecg.base + (Math.random() - 0.5) * 0.3;
                ecgPoints.push(point);
            }
            
            const result = {
                temperatura: Math.max(22.0, Math.min(26.0, temp + timeVariation)).toFixed(1),
                puls: Math.max(30, Math.min(200, Math.round(puls + timeVariation * 5))),
                umiditate: Math.max(35, Math.min(50, Math.round(umiditate + timeVariation * 2))),
                ecg: Math.max(0.5, Math.min(5.0, profile.ecg.base + timeVariation * 0.5)).toFixed(1),
                timestamp: new Date().toLocaleString('ro-RO'),
                patientInfo: {
                    name: profile.name,
                    condition: profile.condition,
                    hasAnomaly: profile.ecg.anomaly
                },
                ecgRealTime: {
                    rawData: ecgPoints,
                    heartRate: Math.round(puls + timeVariation * 5),
                    rhythm: profile.ecg.anomaly ? 'arrhythmia' : 'normal',
                    sampleRate: 100
                }
            };
            
            // SimuleazƒÉ primirea datelor ECG √Æn timp real
            if (selectedPatientId == patientId) {
                processRealTimeECG(result.ecgRealTime);
            }
            
            return result;
        }

        // Generare puncte ECG pentru streaming simulat
        function generateECGPoints() {
            const points = [];
            for (let i = 0; i < 10; i++) {
                points.push((Math.random() - 0.5) * 1.5);
            }
            return points;
        }

        // FUNC»öIILE ECG (pƒÉstrate din versiunea originalƒÉ)
        function initializeECG() {
            ecgCanvas = document.getElementById('ecg-canvas');
            if (!ecgCanvas) return;
            
            ecgCtx = ecgCanvas.getContext('2d');
            
            const rect = ecgCanvas.getBoundingClientRect();
            ecgCanvas.width = rect.width * 2;
            ecgCanvas.height = rect.height * 2;
            ecgCtx.scale(2, 2);
            
            startECGAnimation();
        }

        function processRealTimeECG(ecgDataFromCloud) {
            try {
                if (Array.isArray(ecgDataFromCloud)) {
                    addECGPointsToBuffer(ecgDataFromCloud);
                } else if (ecgDataFromCloud.rawData) {
                    addECGPointsToBuffer(ecgDataFromCloud.rawData);
                    updateECGMetrics(ecgDataFromCloud);
                } else if (typeof ecgDataFromCloud === 'number') {
                    addECGPointsToBuffer([ecgDataFromCloud]);
                }
                
                isReceivingRealECG = true;
            } catch (error) {
                console.error('Eroare procesare ECG real:', error);
                isReceivingRealECG = false;
            }
        }

        function addECGPointsToBuffer(newPoints) {
            ecgDataBuffer.push(...newPoints);
            
            if (ecgDataBuffer.length > maxECGBufferSize) {
                ecgDataBuffer = ecgDataBuffer.slice(-maxECGBufferSize);
            }
        }

        function updateECGMetrics(ecgData) {
            if (ecgData.heartRate) {
                document.getElementById('ecg-bpm').textContent = `${ecgData.heartRate} BPM`;
            }
            
            if (ecgData.rhythm) {
                const rhythmElement = document.getElementById('ecg-rhythm');
                rhythmElement.textContent = getECGRhythmText(ecgData.rhythm);
                rhythmElement.style.color = getECGRhythmColor(ecgData.rhythm);
            }
        }

        function getECGRhythmText(rhythm) {
            const rhythms = {
                'normal': 'Ritm sinusal normal',
                'arrhythmia': 'Aritmie detectatƒÉ',
                'tachycardia': 'Tahicardie',
                'bradycardia': 'Bradicardie',
                'irregular': 'Ritm neregulat',
                'atrial_fib': 'Fibrila»õie atrialƒÉ'
            };
            return rhythms[rhythm] || 'Ritm necunoscut';
        }

        function getECGRhythmColor(rhythm) {
            const colors = {
                'normal': '#00ff00',
                'arrhythmia': '#ff4444',
                'tachycardia': '#ffaa00',
                'bradycardia': '#ffaa00',
                'irregular': '#ff4444',
                'atrial_fib': '#ff4444'
            };
            return colors[rhythm] || '#ffffff';
        }

        function startECGAnimation() {
            const canvas = ecgCanvas;
            const ctx = ecgCtx;
            if (!canvas || !ctx) return;
            
            const width = canvas.width / 2;
            const height = canvas.height / 2;
            const centerY = height / 2;
            
            function animate() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                drawECGGrid(ctx, width, height);
                
                let hasAnomaly = false;
                
                if (isReceivingRealECG && ecgDataBuffer.length > 0) {
                    drawRealECGData(ctx, width, height, centerY);
                    hasAnomaly = detectECGAnomalies();
                } else {
                    drawSimulatedECGData(ctx, width, height, centerY);
                    hasAnomaly = isECGAnomalous();
                }
                
                ecgAnimation = requestAnimationFrame(animate);
            }
            
            animate();
        }

        function drawRealECGData(ctx, width, height, centerY) {
            if (ecgDataBuffer.length < 2) return;
            
            const hasAnomaly = detectECGAnomalies();
            ctx.strokeStyle = hasAnomaly ? '#ff4444' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const pointsToShow = Math.min(ecgDataBuffer.length, width);
            const startIndex = Math.max(0, ecgDataBuffer.length - pointsToShow);
            
            for (let i = 0; i < pointsToShow; i++) {
                const dataIndex = startIndex + i;
                const amplitude = ecgDataBuffer[dataIndex];
                
                const normalizedAmplitude = Math.max(-1, Math.min(1, amplitude / 2));
                
                const x = (i / pointsToShow) * width;
                const y = centerY - (normalizedAmplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
            
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.beginPath();
            const sweepX = (Date.now() / 50) % width;
            ctx.moveTo(sweepX, 0);
            ctx.lineTo(sweepX, height);
            ctx.stroke();
        }

        function drawSimulatedECGData(ctx, width, height, centerY) {
            const currentTime = Date.now() / 1000;
            const heartRate = getCurrentHeartRate();
            const hasAnomaly = isECGAnomalous();
            
            ctx.strokeStyle = hasAnomaly ? '#ff4444' : '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const samplesPerSecond = 50;
            const secondsVisible = 6;
            const totalSamples = samplesPerSecond * secondsVisible;
            
            for (let i = 0; i < totalSamples; i++) {
                const timeOffset = (i / samplesPerSecond) - secondsVisible;
                const sampleTime = currentTime + timeOffset;
                const amplitude = generateECGWave(sampleTime, heartRate, hasAnomaly);
                
                const x = (i / totalSamples) * width;
                const y = centerY - (amplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
        }

        function detectECGAnomalies() {
            if (ecgDataBuffer.length < 100) return false;
            
            const recentData = ecgDataBuffer.slice(-100);
            
            const mean = recentData.reduce((a, b) => a + b, 0) / recentData.length;
            const variance = recentData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / recentData.length;
            const stdDev = Math.sqrt(variance);
            
            const extremeValues = recentData.filter(val => Math.abs(val - mean) > 3 * stdDev);
            
            return extremeValues.length > recentData.length * 0.05;
        }

        function generateECGWave(time, heartRate = 75, anomaly = false) {
            const beatInterval = 60 / heartRate;
            const beatPhase = (time % beatInterval) / beatInterval;
            
            let amplitude = 0;
            
            if (beatPhase < 0.1) {
                amplitude = 0.2 * Math.sin(beatPhase * 10 * Math.PI);
            } else if (beatPhase < 0.2) {
                amplitude = 0;
            } else if (beatPhase < 0.35) {
                const qrsPhase = (beatPhase - 0.2) / 0.15;
                if (qrsPhase < 0.3) {
                    amplitude = -0.3 * Math.sin(qrsPhase * 3.33 * Math.PI);
                } else if (qrsPhase < 0.7) {
                    amplitude = 1.5 * Math.sin((qrsPhase - 0.3) * 2.5 * Math.PI);
                } else {
                    amplitude = -0.4 * Math.sin((qrsPhase - 0.7) * 3.33 * Math.PI);
                }
            } else if (beatPhase < 0.5) {
                amplitude = 0;
            } else if (beatPhase < 0.7) {
                amplitude = 0.3 * Math.sin((beatPhase - 0.5) * 5 * Math.PI);
            } else {
                amplitude = 0;
            }
            
            if (anomaly) {
                amplitude += 0.2 * Math.sin(time * 20) * Math.random();
            }
            
            amplitude += (Math.random() - 0.5) * 0.05;
            
            return amplitude;
        }

        function drawECGGrid(ctx, width, height) {
            ctx.strokeStyle = '#004400';
            ctx.lineWidth = 0.5;
            
            const verticalSpacing = width / 30;
            for (let x = 0; x < width; x += verticalSpacing) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            const horizontalSpacing = height / 10;
            for (let y = 0; y < height; y += horizontalSpacing) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            ctx.strokeStyle = '#006600';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();
        }

        function getCurrentHeartRate() {
            if (selectedPatientId) {
                const pulseElement = document.getElementById('pulse-value');
                const pulseText = pulseElement.textContent;
                const pulse = parseInt(pulseText.replace(' BPM', ''));
                return isNaN(pulse) ? 75 : pulse;
            }
            return 75;
        }

        function isECGAnomalous() {
            if (selectedPatientId) {
                const statusElement = document.getElementById('ecg-status');
                return statusElement.className.includes('critical') || statusElement.className.includes('warning');
            }
            return false;
        }
    </script>
</body>
</html>
