<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Medical - Monitor Pacien»õi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .config-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto 30px;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c5282;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2c5282;
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 82, 130, 0.3);
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .doctor-info {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .doctor-details h3 {
            color: #2c5282;
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .logout-btn {
            background: #e53e3e;
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
        }

        .patients-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .patients-list h3 {
            color: #2c5282;
            margin-bottom: 25px;
            font-size: 1.5em;
            text-align: center;
        }

        .patient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .patient-item:hover {
            border-color: #2c5282;
            background: #f0f4f8;
            transform: translateY(-2px);
        }

        .patient-item.selected {
            border-color: #2c5282;
            background: #e6f3ff;
        }

        .patient-info {
            flex-grow: 1;
        }

        .patient-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .patient-details {
            color: #666;
            font-size: 0.95em;
        }

        .patient-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .alert-normal {
            background: #48bb78;
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.2);
        }

        .alert-warning {
            background: #ed8936;
            box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            animation: pulse-warning 2s infinite;
        }

        .alert-critical {
            background: #e53e3e;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            animation: pulse-critical 1s infinite;
        }

        .alert-offline {
            background: #a0aec0;
            box-shadow: 0 0 0 3px rgba(160, 174, 192, 0.2);
        }

        @keyframes pulse-warning {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(237, 137, 54, 0.2);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 0 6px rgba(237, 137, 54, 0.4);
            }
        }

        @keyframes pulse-critical {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.3);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 0 8px rgba(229, 62, 62, 0.6);
            }
        }

        .patient-values {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .patient-values.active {
            display: block;
        }

        .patient-values h4 {
            color: #2c5282;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .values-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .value-item {
            text-align: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .ecg-item {
            grid-column: span 2;
            text-align: left;
        }

        .ecg-container {
            background: #000;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            border: 2px solid #333;
        }

        #ecg-canvas {
            width: 100%;
            height: 150px;
            display: block;
            border-radius: 4px;
        }

        .ecg-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
        }

        .ecg-mode-selector {
            display: flex;
            gap: 10px;
        }

        .ecg-mode-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .ecg-mode-btn.active {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
        }

        .ecg-mode-btn:hover {
            background: #555;
        }

        .ecg-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: #1a1a1a;
            padding: 8px 12px;
            border-radius: 5px;
        }

        .ecg-metrics {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .ecg-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ecg-metric-label {
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
        }

        .ecg-metric-value {
            font-size: 14px;
            font-weight: bold;
        }

        .ecg-data-display {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 8px;
            border-radius: 3px;
            margin-top: 5px;
            max-height: 60px;
            overflow-y: auto;
            border: 1px solid #333;
        }

        .value-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .value-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
        }

        .value-status {
            font-size: 0.8em;
            margin-top: 5px;
            padding: 3px 8px;
            border-radius: 12px;
        }

        .status-normal { background: #c6f6d5; color: #22543d; }
        .status-warning { background: #feebc8; color: #c05621; }
        .status-critical { background: #fed7d7; color: #c53030; }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #fc8181;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #9ae6b4;
        }

        .info {
            background: #bee3f8;
            color: #2c5282;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #63b3ed;
        }

        .last-update {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-disconnected {
            background: #fed7d7;
            color: #c53030;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">üîå Verificare conexiune...</div>

    <div class="container">
        <div class="header">
            <h1>‚öïÔ∏è Portal Medical</h1>
            <p>Monitor pacien»õi √Æn timp real</p>
        </div>

        <!-- Configurare API -->
        <div id="config-section" class="config-section">
            <h3>‚öôÔ∏è Conexiune la API-ul PHP (XAMPP + ngrok)</h3>
            <p style="margin-bottom: 15px; color: #856404;">
                <strong>‚úÖ API-ul colegului (PHP/XAMPP):</strong> <code>https://fcc8-2a02-2f09-3c02-b600-f14c-834e-2af7-60da.ngrok-free.app</code><br>
                Endpoint-uri disponibile: <code>/login_medic.php</code>, <code>/get_pacienti.php</code>, <code>/get_masuratori.php</code>
            </p>
            <input type="text" id="api-url" class="config-input" 
                   placeholder="URL API actualizat de coleg"
                   value="https://fcc8-2a02-2f09-3c02-b600-f14c-834e-2af7-60da.ngrok-free.app">
            <button class="btn btn-small" onclick="saveApiConfig()">TesteazƒÉ conexiunea</button>
            
            <!-- Buton pentru debugging detaliat -->
            <button class="btn btn-small" onclick="debugApiConnection()" 
                    style="background: #e53e3e; margin-left: 10px;">
                üîç Debug conexiune
            </button>
        </div>

        <!-- Mesaje -->
        <div id="messages"></div>

        <!-- Sec»õiunea de autentificare pentru medici -->
        <div id="auth-section" class="auth-section">
            <div class="login-form">
                <h2>ü©∫ Autentificare Medic</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="login-id">ID Medic:</label>
                        <input type="number" id="login-id" placeholder="ID-ul medicului (ex: 1)" 
                               value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">ParolƒÉ:</label>
                        <input type="password" id="login-password" placeholder="Parola ta" 
                               value="popescu123" required>
                    </div>
                    <button type="submit" class="btn">Acces Portal Medical</button>
                    
                    <!-- Buton pentru demonstra»õie -->
                    <button type="button" class="btn" onclick="demoMode()" 
                            style="background: #38a169; margin-top: 10px;">
                        üé¨ DEMO - Vezi aplica»õia fƒÉrƒÉ login
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard-ul pentru medici -->
        <div id="dashboard" class="dashboard">
            <!-- Informa»õii medic -->
            <div class="doctor-info">
                <div class="doctor-details">
                    <h3>Dr. <span id="doctor-name">Nume Doctor</span></h3>
                    <p><strong>Email:</strong> <span id="doctor-email">doctor@spital.ro</span></p>
                </div>
                <button class="btn logout-btn" onclick="logout()">Deconectare</button>
            </div>

            <!-- Lista pacien»õilor -->
            <div class="patients-list">
                <h3>üìã Lista Pacien»õi</h3>
                
                <!-- Legenda pentru bulinu»õe -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 0.9em;">
                    <strong>üîç Legenda alertelor:</strong><br>
                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                        <div style="width: 12px; height: 12px; background: #48bb78; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Toate parametrii normali</span>
                    </span>
                    <span style="display: inline-flex; align-items: center; margin-right: 15px;">
                        <div style="width: 12px; height: 12px; background: #ed8936; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Cel pu»õin un parametru la limitƒÉ</span>
                    </span>
                    <span style="display: inline-flex; align-items: center;">
                        <div style="width: 12px; height: 12px; background: #e53e3e; border-radius: 50%; margin-right: 5px;"></div>
                        <span>Cel pu»õin un parametru critic</span>
                    </span>
                </div>
                
                <div id="patients-container">
                    <div class="info">
                        üì° Se √ÆncearcƒÉ conectarea la API pentru √ÆncƒÉrcarea pacien»õilor...
                    </div>
                </div>
            </div>

            <!-- Detalii pacient selectat -->
            <div id="patient-values" class="patient-values">
                <h4>MƒÉsurƒÉtori pentru: <span id="selected-patient-name">-</span></h4>
                <div class="values-grid">
                    <div class="value-item">
                        <div class="value-label">TemperaturƒÉ</div>
                        <div class="value-number" id="temp-value">--¬∞C</div>
                        <div class="value-status status-normal" id="temp-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Puls</div>
                        <div class="value-number" id="pulse-value">-- BPM</div>
                        <div class="value-status status-normal" id="pulse-status">-</div>
                    </div>
                    <div class="value-item">
                        <div class="value-label">Satura»õia O2</div>
                        <div class="value-number" id="oxygen-value">--%</div>
                        <div class="value-status status-normal" id="oxygen-status">-</div>
                    </div>
                    <div class="value-item ecg-item">
                        <div class="value-label">ElectrocardiogramƒÉ (ECG)</div>
                        
                        <!-- Controale ECG -->
                        <div class="ecg-controls">
                            <div class="ecg-mode-selector">
                                <button class="ecg-mode-btn active" onclick="setECGMode('realtime')" id="mode-realtime">Date Reale</button>
                                <button class="ecg-mode-btn" onclick="setECGMode('simulated')" id="mode-simulated">Simulat</button>
                                <button class="ecg-mode-btn" onclick="setECGMode('raw')" id="mode-raw">Valori Raw</button>
                            </div>
                            <div style="color: #00ff00; font-size: 12px;">
                                Status: <span id="ecg-data-status">Waiting for data...</span>
                            </div>
                        </div>
                        
                        <div class="ecg-container">
                            <canvas id="ecg-canvas" width="600" height="150"></canvas>
                            
                            <div class="ecg-info">
                                <div class="ecg-metrics">
                                    <div class="ecg-metric">
                                        <span class="ecg-metric-label">Heart Rate</span>
                                        <span class="ecg-metric-value" id="ecg-bpm">-- BPM</span>
                                    </div>
                                    <div class="ecg-metric">
                                        <span class="ecg-metric-label">Rhythm</span>
                                        <span class="ecg-metric-value" id="ecg-rhythm">--</span>
                                    </div>
                                    <div class="ecg-metric">
                                        <span class="ecg-metric-label">Raw Value</span>
                                        <span class="ecg-metric-value" id="ecg-raw-value">--</span>
                                    </div>
                                    <div class="ecg-metric">
                                        <span class="ecg-metric-label">Last Update</span>
                                        <span class="ecg-metric-value" id="ecg-timestamp">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Afi»ôare date raw ECG -->
                        <div class="ecg-data-display" id="ecg-raw-display">
                            Waiting for ECG data from database...
                        </div>
                        
                        <div class="value-status status-normal" id="ecg-status">Waiting for data</div>
                    </div>
                </div>
            </div>

            <div class="last-update">
                Ultima actualizare: <span id="last-update">-</span>
            </div>
        </div>
    </div>

    <script>
        // üìÅ Configura»õie API PHP
        let API_BASE_URL = "https://fcc8-2a02-2f09-3c02-b600-f14c-834e-2af7-60da.ngrok-free.app";
        let authToken = localStorage.getItem('authToken');
        let currentDoctor = JSON.parse(localStorage.getItem('currentDoctor') || '{}');
        let selectedPatientId = null;
        let updateInterval = null;
        let isApiConnected = false;

        // Variabile pentru ECG √ÆmbunƒÉtƒÉ»õit
        let ecgCanvas = null;
        let ecgCtx = null;
        let ecgDataBuffer = [];
        let ecgAnimation = null;
        let ecgTime = 0;
        let maxECGBufferSize = 1000;
        let ecgMode = 'realtime'; // 'realtime', 'simulated', 'raw'
        let lastECGData = null;
        let ecgUpdateCount = 0;

        // Func»õie de debugging pentru conexiune API
        async function debugApiConnection() {
            console.log('üîß √éNCEPERE DEBUG CONEXIUNE API');
            showMessage('üîç Rulare teste de debugging...', 'info');
            
            const apiUrl = document.getElementById('api-url').value.trim();
            
            // Test 1: Ping simplu fƒÉrƒÉ headers care cauzeazƒÉ CORS
            console.log('üì° Test 1: Ping la URL de bazƒÉ...');
            try {
                const pingResponse = await fetch(apiUrl, {
                    method: 'GET',
                    mode: 'no-cors',
                    signal: AbortSignal.timeout(5000)
                });
                console.log(`‚úÖ Ping reu»ôit: ${pingResponse.status || 'opaque response'}`);
                showMessage('‚úÖ Serverul rƒÉspunde, dar CORS nu e configurat corect', 'warning');
            } catch (error) {
                console.error(`‚ùå Ping e»ôuat:`, error);
                showMessage(`‚ùå Ping la ${apiUrl} a e»ôuat: ${error.message}`, 'error');
                return;
            }
            
            // Test 2: VerificƒÉ CORS pentru fiecare endpoint
            const endpoints = [
                'get_pacienti.php',
                'login_medic.php', 
                'get_masuratori.php'
            ];
            
            for (let endpoint of endpoints) {
                console.log(`üì° Test CORS endpoint: ${endpoint}`);
                try {
                    const testResponse = await fetch(`${apiUrl}/${endpoint}`, {
                        method: 'OPTIONS',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    console.log(`üìä ${endpoint} CORS: ${testResponse.status}`);
                    
                    if (testResponse.status === 404) {
                        showMessage(`‚ùå ${endpoint} nu existƒÉ pe server (404)`, 'error');
                    } else if (testResponse.ok || testResponse.status === 405) {
                        showMessage(`‚úÖ ${endpoint} existƒÉ, dar CORS lipse»ôte`, 'warning');
                    }
                } catch (error) {
                    console.error(`‚ùå Eroare CORS ${endpoint}:`, error);
                    showMessage(`‚ùå ${endpoint}: CORS blocat`, 'error');
                }
            }
            
            showMessage(`üö´ PROBLEMA IDENTIFICATƒÇ: CORS nu e configurat in PHP!

Spune colegului sƒÉ adauge √Æn TOATE fi»ôierele PHP (.php):

<?php
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, ngrok-skip-browser-warning");

if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    http_response_code(200);
    exit();
}
// ... restul codului PHP
?>

Apoi sƒÉ reporneascƒÉ XAMPP »ôi sƒÉ testeze din nou.`, 'error');
            
            console.log('üîß FINALIZARE DEBUG CONEXIUNE API');
        }

        // üîê Login medic folosind API-ul PHP
        async function apiLoginPHP(idMedic, parola) {
            try {
                const response = await fetch(`${API_BASE_URL}/login_medic.php`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ id_medic: parseInt(idMedic), parola: parola }),
                });
                
                const data = await response.json();
                console.log('RƒÉspuns login PHP:', data);
                return data;
            } catch (error) {
                console.error('Eroare API login PHP:', error);
                throw error;
            }
        }

        // üìã Lista pacien»õilor din API-ul PHP
        async function getPacientiPHP() {
            try {
                const response = await fetch(`${API_BASE_URL}/get_pacienti.php`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    }
                });
                
                const data = await response.json();
                console.log('RƒÉspuns pacienti PHP:', data);
                return data;
            } catch (error) {
                console.error('Eroare API pacienti PHP:', error);
                throw error;
            }
        }

        // üìä MƒÉsurƒÉtori pentru pacient din API-ul PHP  
        async function getMasuratori_PHP(idPacient) {
            try {
                const response = await fetch(`${API_BASE_URL}/get_masuratori.php`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json", 
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify({ id_pacient: parseInt(idPacient) })
                });
                
                const data = await response.json();
                console.log('RƒÉspuns masuratori PHP pentru pacient', idPacient, ':', data);
                return data;
            } catch (error) {
                console.error('Eroare API masuratori PHP:', error);
                throw error;
            }
        }

        // Ini»õializare c√¢nd se √ÆncarcƒÉ aplica»õia
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('api-url').value = API_BASE_URL;
            testApiConnection();
            
            if (authToken) {
                showDashboard();
            }
        });

        // Salvare configurare API
        function saveApiConfig() {
            const apiUrl = document.getElementById('api-url').value.trim();
            if (!apiUrl) {
                showMessage('Te rog introdu URL-ul API-ului!', 'error');
                return;
            }
            
            API_BASE_URL = apiUrl.replace(/\/$/, '');
            localStorage.setItem('api_base_url', API_BASE_URL);
            
            showMessage('Configurare salvatƒÉ! Se testeazƒÉ conexiunea...', 'info');
            testApiConnection();
        }

        // Test conexiune API PHP
        async function testApiConnection() {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = 'üîÑ Testare conexiune...';
            statusElement.className = 'connection-status';
            
            console.log(`üîç Testare conexiune la: ${API_BASE_URL}`);
            
            try {
                const response = await fetch(`${API_BASE_URL}/get_pacienti.php`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    signal: AbortSignal.timeout(10000)
                });
                
                if (response.ok) {
                    const responseText = await response.text();
                    const jsonData = JSON.parse(responseText);
                    
                    isApiConnected = true;
                    statusElement.textContent = '‚úÖ API PHP conectat';
                    statusElement.className = 'connection-status status-connected';
                    document.getElementById('config-section').style.display = 'none';
                    showMessage('API PHP conectat cu succes!', 'success');
                } else {
                    throw new Error(`Status ${response.status}`);
                }
            } catch (error) {
                isApiConnected = false;
                statusElement.textContent = '‚ùå API deconectat';
                statusElement.className = 'connection-status status-disconnected';
                document.getElementById('config-section').style.display = 'block';
                showMessage(`Eroare conexiune: ${error.message}`, 'error');
            }
        }

        // Func»õie pentru afi»ôarea mesajelor
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Gestionare login
        async function handleLogin(event) {
            event.preventDefault();
            
            const idMedic = document.getElementById('login-id').value;
            const parola = document.getElementById('login-password').value;

            if (!idMedic || !parola) {
                showMessage('Te rog completeazƒÉ ID-ul medicului »ôi parola!', 'error');
                return;
            }

            try {
                showMessage('Se √ÆncearcƒÉ conectarea la API-ul PHP...', 'info');
                
                const loginResult = await apiLoginPHP(idMedic, parola);
                
                if (loginResult.success && loginResult.medic) {
                    authToken = `php_token_${loginResult.medic.id}_${Date.now()}`;
                    currentDoctor = {
                        id: loginResult.medic.id,
                        nume: `Dr. ${loginResult.medic.nume} ${loginResult.medic.prenume}`,
                        email: loginResult.medic.email,
                        prenume: loginResult.medic.prenume,
                        nume_familie: loginResult.medic.nume
                    };
                    
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentDoctor', JSON.stringify(currentDoctor));
                    
                    showMessage('Autentificare reu»ôitƒÉ!', 'success');
                    showDashboard();
                } else {
                    throw new Error(loginResult.message || 'Date de autentificare incorecte');
                }
            } catch (error) {
                showMessage(`Eroare de conectare: ${error.message}`, 'error');
            }
        }

        // Afi»ôare dashboard
        async function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('config-section').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            
            document.getElementById('doctor-name').textContent = currentDoctor.nume || 'Doctor';
            document.getElementById('doctor-email').textContent = currentDoctor.email || 'doctor@spital.ro';
            
            await loadPatientsPHP();
            initializeECG();
            startMonitoring();
        }

        // √éncƒÉrcare pacien»õi
        async function loadPatientsPHP() {
            try {
                showMessage('Se √ÆncarcƒÉ pacien»õii din API-ul PHP...', 'info');
                
                const pacientiResult = await getPacientiPHP();
                
                if (pacientiResult.success && pacientiResult.pacienti) {
                    const patients = pacientiResult.pacienti;
                    
                    const adaptedPatients = patients.map(patient => ({
                        id_pacient: patient.id_pacient,
                        nume: patient.nume || 'Necunoscut',
                        prenume: patient.prenume || 'Pacient',
                        email: patient.email || 'N/A',
                        telefon: patient.telefon || 'N/A',
                        data_nasterii: patient.data_nasterii || 'N/A',
                        camera: `Camera ${patient.id_pacient + 100}`,
                        diagnostic: 'Monitorizare medicalƒÉ'
                    }));
                    
                    displayPatients(adaptedPatients);
                    showMessage(`${adaptedPatients.length} pacien»õi √ÆncƒÉrca»õi`, 'success');
                } else {
                    throw new Error('Nu s-au putut √ÆncƒÉrca pacien»õii');
                }
            } catch (error) {
                const container = document.getElementById('patients-container');
                container.innerHTML = `<div class="error">‚ùå Eroare: ${error.message}</div>`;
                showMessage('Eroare la √ÆncƒÉrcarea pacien»õilor', 'error');
            }
        }

        // Afi»ôare lista pacien»õilor
        function displayPatients(patients) {
            const container = document.getElementById('patients-container');
            
            if (!patients || patients.length === 0) {
                container.innerHTML = `<div class="info">üìã Nu sunt pacien»õi √Ænregistra»õi.</div>`;
                return;
            }

            container.innerHTML = '';

            patients.forEach(patient => {
                const patientElement = document.createElement('div');
                patientElement.className = 'patient-item';
                patientElement.onclick = () => selectPatient(
                    patient.id_pacient || patient.id, 
                    `${patient.prenume} ${patient.nume}`
                );
                
                patientElement.innerHTML = `
                    <div class="patient-info">
                        <div class="patient-name">${patient.prenume} ${patient.nume}</div>
                        <div class="patient-details">
                            üìß ${patient.email || 'N/A'} | 
                            üè• ${patient.camera || 'N/A'} | 
                            üìã ${patient.diagnostic || 'Monitorizare generalƒÉ'}
                        </div>
                    </div>
                    <div class="patient-status">
                        <div class="alert-indicator alert-offline" id="alert-${patient.id_pacient || patient.id}"></div>
                    </div>
                `;
                
                container.appendChild(patientElement);
            });
        }

        // Selectare pacient
        function selectPatient(patientId, patientName) {
            console.log(`Selectare pacient: ${patientId} - ${patientName}`);
            
            document.querySelectorAll('.patient-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            event.target.closest('.patient-item').classList.add('selected');
            
            selectedPatientId = patientId;
            document.getElementById('selected-patient-name').textContent = patientName;
            document.getElementById('patient-values').classList.add('active');
            
            // Reset ECG pentru noul pacient
            resetECGForNewPatient();
            
            setTimeout(async () => {
                const measurements = await getPatientMeasurementsPHP(patientId);
                updateSelectedPatientValues(measurements);
            }, 100);
        }

        // Ob»õinere mƒÉsurƒÉtori din API PHP cu focus pe ECG
        async function getPatientMeasurementsPHP(patientId) {
            console.log(`Ob»õinere mƒÉsurƒÉtori pentru pacientul ${patientId}`);
            
            try {
                const masuratori = await getMasuratori_PHP(patientId);
                console.log(`MƒÉsurƒÉtori complete:`, masuratori);
                
                if (masuratori.success && masuratori.masuratori && masuratori.masuratori.length > 0) {
                    const latestMeasurement = masuratori.masuratori[masuratori.masuratori.length - 1];
                    console.log(`üìä Ultima mƒÉsurƒÉtoare:`, latestMeasurement);
                    
                    // ProceseazƒÉ datele ECG reale
                    const ecgValue = parseFloat(latestMeasurement.ecg || 0);
                    const pulseValue = parseInt(latestMeasurement.puls || 0);
                    
                    // ActualizeazƒÉ ECG-ul cu datele reale
                    updateECGWithRealData(ecgValue, pulseValue, latestMeasurement);
                    
                    return {
                        temperatura: latestMeasurement.temperatura || '0', 
                        puls: latestMeasurement.puls || '0',
                        umiditate: latestMeasurement.umiditate || '0', 
                        ecg: latestMeasurement.ecg || '0', 
                        timestamp: latestMeasurement.timestamp || new Date().toLocaleString('ro-RO'),
                        totalMeasurements: masuratori.masuratori.length,
                        allMeasurements: masuratori.masuratori // PƒÉstreazƒÉ toate mƒÉsurƒÉtorile pentru analiza ECG
                    };
                } else {
                    console.log(`‚ö†Ô∏è Nu sunt mƒÉsurƒÉtori pentru pacientul ${patientId}`);
                    updateECGDataStatus('No data available');
                    return {
                        temperatura: '--',
                        puls: '--',
                        umiditate: '--',
                        ecg: '--',
                        timestamp: 'Nu sunt date disponibile',
                        totalMeasurements: 0
                    };
                }
            } catch (error) {
                console.error('Eroare mƒÉsurƒÉtori:', error);
                updateECGDataStatus('Error: ' + error.message);
                return {
                    temperatura: 'Eroare',
                    puls: 'Eroare',
                    umiditate: 'Eroare',
                    ecg: 'Eroare',
                    timestamp: 'Eroare de conexiune',
                    totalMeasurements: 0
                };
            }
        }

        // === FUNC»öII ECG √éMBUNƒÇTƒÇ»öITE ===

        // Setare mod ECG
        function setECGMode(mode) {
            ecgMode = mode;
            
            // ActualizeazƒÉ butoanele
            document.querySelectorAll('.ecg-mode-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');
            
            // ActualizeazƒÉ afi»ôarea
            updateECGDisplay();
            
            console.log(`ECG mode changed to: ${mode}`);
        }

        // Ini»õializare ECG √ÆmbunƒÉtƒÉ»õitƒÉ
        function initializeECG() {
            ecgCanvas = document.getElementById('ecg-canvas');
            if (!ecgCanvas) return;
            
            ecgCtx = ecgCanvas.getContext('2d');
            
            // SeteazƒÉ dimensiunile canvas-ului
            const rect = ecgCanvas.getBoundingClientRect();
            ecgCanvas.width = rect.width * window.devicePixelRatio;
            ecgCanvas.height = rect.height * window.devicePixelRatio;
            ecgCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            // Ini»õializeazƒÉ buffer-ul ECG
            ecgDataBuffer = [];
            ecgUpdateCount = 0;
            
            startECGAnimation();
            updateECGDataStatus('ECG initialized - waiting for data');
        }

        // Reset ECG pentru pacient nou
        function resetECGForNewPatient() {
            ecgDataBuffer = [];
            lastECGData = null;
            ecgUpdateCount = 0;
            
            // Reset afi»ôare
            document.getElementById('ecg-bpm').textContent = '-- BPM';
            document.getElementById('ecg-rhythm').textContent = '--';
            document.getElementById('ecg-raw-value').textContent = '--';
            document.getElementById('ecg-timestamp').textContent = '--';
            document.getElementById('ecg-raw-display').textContent = 'Loading ECG data for new patient...';
            
            updateECGDataStatus('Loading patient data...');
        }

        // Actualizare ECG cu date reale din baza de date
        function updateECGWithRealData(ecgValue, pulseValue, measurementData) {
            lastECGData = {
                rawValue: ecgValue,
                pulse: pulseValue,
                timestamp: measurementData.timestamp,
                measurement: measurementData
            };
            
            // ActualizeazƒÉ metricile afi»ôate
            document.getElementById('ecg-raw-value').textContent = ecgValue.toFixed(3);
            document.getElementById('ecg-bpm').textContent = `${pulseValue} BPM`;
            document.getElementById('ecg-timestamp').textContent = new Date(measurementData.timestamp).toLocaleTimeString('ro-RO');
            
            // DeterminƒÉ ritmul bazat pe valorile reale
            const rhythm = determineECGRhythm(ecgValue, pulseValue);
            document.getElementById('ecg-rhythm').textContent = rhythm;
            
            // AdaugƒÉ valoarea √Æn buffer pentru afi»ôare graficƒÉ
            if (ecgMode === 'realtime') {
                addECGDataToBuffer(ecgValue);
            }
            
            // ActualizeazƒÉ afi»ôarea datelor raw
            updateRawDataDisplay(measurementData);
            
            // ActualizeazƒÉ statusul
            updateECGDataStatus(`Real data received: ${ecgValue.toFixed(3)}V`);
            
            ecgUpdateCount++;
            console.log(`üìà ECG actualizat #${ecgUpdateCount}: ${ecgValue}V, ${pulseValue} BPM`);
        }

        // AdaugƒÉ date ECG √Æn buffer
        function addECGDataToBuffer(value) {
            // Converte»ôte valoarea realƒÉ √Æntr-o formƒÉ vizibilƒÉ pe grafic
            const normalizedValue = normalizeECGValue(value);
            ecgDataBuffer.push(normalizedValue);
            
            // LimiteazƒÉ dimensiunea buffer-ului
            if (ecgDataBuffer.length > maxECGBufferSize) {
                ecgDataBuffer.shift();
            }
        }

        // NormalizeazƒÉ valoarea ECG pentru afi»ôare graficƒÉ
        function normalizeECGValue(rawValue) {
            // Valorile din baza de date par sƒÉ fie √Æn jur de 0-5V
            // Le mapƒÉm la intervalul -1 to 1 pentru afi»ôare
            
            // SimuleazƒÉ o undƒÉ ECG bazatƒÉ pe valoarea realƒÉ
            const baseAmplitude = Math.max(-1, Math.min(1, (rawValue - 2.5) / 2.5));
            
            // AdaugƒÉ o componentƒÉ de undƒÉ ECG realistƒÉ
            const time = Date.now() / 1000;
            const heartRate = lastECGData ? lastECGData.pulse : 75;
            const ecgWave = generateECGWaveFromValue(time, heartRate, rawValue);
            
            return baseAmplitude * 0.3 + ecgWave * 0.7;
        }

        // GenereazƒÉ undƒÉ ECG bazatƒÉ pe valoarea realƒÉ
        function generateECGWaveFromValue(time, heartRate, rawValue) {
            const beatInterval = 60 / heartRate;
            const beatPhase = (time % beatInterval) / beatInterval;
            
            // ModuleazƒÉ amplitudinea bazatƒÉ pe valoarea realƒÉ din DB
            const amplitudeFactor = Math.max(0.5, Math.min(2.0, rawValue / 2.5));
            
            let amplitude = 0;
            
            // Complexul QRS simplificat
            if (beatPhase < 0.1) {
                // Unda P
                amplitude = 0.2 * Math.sin(beatPhase * 10 * Math.PI) * amplitudeFactor;
            } else if (beatPhase < 0.3) {
                // Complexul QRS
                const qrsPhase = (beatPhase - 0.1) / 0.2;
                if (qrsPhase < 0.3) {
                    amplitude = -0.3 * Math.sin(qrsPhase * 3.33 * Math.PI) * amplitudeFactor;
                } else if (qrsPhase < 0.7) {
                    amplitude = 1.2 * Math.sin((qrsPhase - 0.3) * 2.5 * Math.PI) * amplitudeFactor;
                } else {
                    amplitude = -0.4 * Math.sin((qrsPhase - 0.7) * 3.33 * Math.PI) * amplitudeFactor;
                }
            } else if (beatPhase < 0.6) {
                // Unda T
                amplitude = 0.3 * Math.sin((beatPhase - 0.3) * 3.33 * Math.PI) * amplitudeFactor;
            }
            
            // AdaugƒÉ varia»õie bazatƒÉ pe valoarea din DB
            amplitude += (rawValue - 2.5) * 0.1 * Math.sin(time * 10);
            
            return amplitude;
        }

        // DeterminƒÉ ritmul ECG bazat pe valori reale
        function determineECGRhythm(ecgValue, pulseValue) {
            if (pulseValue === 0 || ecgValue === 0) {
                return 'No signal';
            } else if (pulseValue > 100) {
                return 'Tachycardia';
            } else if (pulseValue < 60) {
                return 'Bradycardia';
            } else if (ecgValue > 4.0 || ecgValue < 1.0) {
                return 'Abnormal';
            } else {
                return 'Normal sinus';
            }
        }

        // ActualizeazƒÉ afi»ôarea datelor raw
        function updateRawDataDisplay(measurementData) {
            const display = document.getElementById('ecg-raw-display');
            const timestamp = new Date(measurementData.timestamp).toLocaleString('ro-RO');
            
            const rawText = `
[${timestamp}] ECG Raw Data:
- Value: ${measurementData.ecg}V
- Pulse: ${measurementData.puls} BPM  
- Temperature: ${measurementData.temperatura}¬∞C
- Humidity: ${measurementData.umiditate}%
- Update #${ecgUpdateCount}
            `.trim();
            
            display.textContent = rawText;
        }

        // ActualizeazƒÉ statusul datelor ECG
        function updateECGDataStatus(status) {
            document.getElementById('ecg-data-status').textContent = status;
        }

        // ActualizeazƒÉ afi»ôarea ECG
        function updateECGDisplay() {
            // LogicƒÉ suplimentarƒÉ pentru diferite moduri de afi»ôare
            if (ecgMode === 'raw' && lastECGData) {
                // √én modul raw, afi»ôeazƒÉ doar valorile numerice
                updateRawDataDisplay(lastECGData.measurement);
            }
        }

        // Anima»õia ECG √ÆmbunƒÉtƒÉ»õitƒÉ
        function startECGAnimation() {
            const canvas = ecgCanvas;
            const ctx = ecgCtx;
            if (!canvas || !ctx) return;
            
            const width = canvas.width / window.devicePixelRatio;
            const height = canvas.height / window.devicePixelRatio;
            const centerY = height / 2;
            
            function animate() {
                // CurƒÉ»õƒÉ canvas-ul
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, width, height);
                
                // DeseneazƒÉ grila ECG
                drawECGGrid(ctx, width, height);
                
                // DeseneazƒÉ datele ECG conform modului selectat
                switch(ecgMode) {
                    case 'realtime':
                        drawRealTimeECG(ctx, width, height, centerY);
                        break;
                    case 'simulated':
                        drawSimulatedECG(ctx, width, height, centerY);
                        break;
                    case 'raw':
                        drawRawECGValues(ctx, width, height, centerY);
                        break;
                }
                
                // Linia de baleiaj
                drawSweepLine(ctx, width, height);
                
                ecgAnimation = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // DeseneazƒÉ ECG √Æn timp real (date din DB)
        function drawRealTimeECG(ctx, width, height, centerY) {
            if (ecgDataBuffer.length < 2) {
                // DacƒÉ nu avem date, afi»ôeazƒÉ linia de bazƒÉ
                ctx.strokeStyle = '#00aa00';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, centerY);
                ctx.lineTo(width, centerY);
                ctx.stroke();
                return;
            }
            
            // DeterminƒÉ culoarea bazatƒÉ pe calitatea semnalului
            const signalQuality = determineSignalQuality();
            ctx.strokeStyle = getECGColor(signalQuality);
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const pointsToShow = Math.min(ecgDataBuffer.length, Math.floor(width / 2));
            const startIndex = Math.max(0, ecgDataBuffer.length - pointsToShow);
            
            for (let i = 0; i < pointsToShow; i++) {
                const dataIndex = startIndex + i;
                const amplitude = ecgDataBuffer[dataIndex];
                
                const x = (i / pointsToShow) * width;
                const y = centerY - (amplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
        }

        // DeseneazƒÉ ECG simulat (pentru demonstra»õie)
        function drawSimulatedECG(ctx, width, height, centerY) {
            const currentTime = Date.now() / 1000;
            const heartRate = lastECGData ? lastECGData.pulse : 75;
            
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const samplesPerSecond = 100;
            const secondsVisible = 4;
            const totalSamples = samplesPerSecond * secondsVisible;
            
            for (let i = 0; i < totalSamples; i++) {
                const timeOffset = (i / samplesPerSecond) - secondsVisible;
                const sampleTime = currentTime + timeOffset;
                const amplitude = generateECGWaveFromValue(sampleTime, heartRate, lastECGData ? lastECGData.rawValue : 2.5);
                
                const x = (i / totalSamples) * width;
                const y = centerY - (amplitude * centerY * 0.8);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            
            ctx.stroke();
        }

        // DeseneazƒÉ valorile raw ECG ca bare
        function drawRawECGValues(ctx, width, height, centerY) {
            if (!lastECGData) {
                ctx.fillStyle = '#ffaa00';
                ctx.font = '16px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('No ECG data available', width/2, centerY);
                return;
            }
            
            // DeseneazƒÉ bara pentru valoarea curentƒÉ
            const value = lastECGData.rawValue;
            const normalizedHeight = (value / 5.0) * height * 0.8; // Presupunem max 5V
            
            ctx.fillStyle = '#00ff00';
            const barWidth = 40;
            const barX = width / 2 - barWidth / 2;
            const barY = centerY + height * 0.4 - normalizedHeight;
            
            ctx.fillRect(barX, barY, barWidth, normalizedHeight);
            
            // Afi»ôeazƒÉ valoarea
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Courier New';
            ctx.textAlign = 'center';
            ctx.fillText(`${value.toFixed(3)}V`, width/2, height - 20);
        }

        // DeseneazƒÉ grila ECG
        function drawECGGrid(ctx, width, height) {
            ctx.strokeStyle = '#003300';
            ctx.lineWidth = 0.5;
            
            // Linii verticale
            const verticalSpacing = width / 25;
            for (let x = 0; x <= width; x += verticalSpacing) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            
            // Linii orizontale
            const horizontalSpacing = height / 10;
            for (let y = 0; y <= height; y += horizontalSpacing) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Linia centralƒÉ
            ctx.strokeStyle = '#006600';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, height / 2);
            ctx.lineTo(width, height / 2);
            ctx.stroke();
        }

        // DeseneazƒÉ linia de baleiaj
        function drawSweepLine(ctx, width, height) {
            const sweepX = (Date.now() / 100) % width;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 2]);
            ctx.beginPath();
            ctx.moveTo(sweepX, 0);
            ctx.lineTo(sweepX, height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // DeterminƒÉ calitatea semnalului
        function determineSignalQuality() {
            if (!lastECGData) return 'no_signal';
            
            const value = lastECGData.rawValue;
            const pulse = lastECGData.pulse;
            
            if (value === 0 || pulse === 0) return 'no_signal';
            if (value < 1 || value > 4 || pulse < 40 || pulse > 150) return 'poor';
            if (pulse < 60 || pulse > 100) return 'warning';
            return 'good';
        }

        // Ob»õine culoarea ECG bazatƒÉ pe calitate
        function getECGColor(quality) {
            const colors = {
                'good': '#00ff00',
                'warning': '#ffaa00', 
                'poor': '#ff4444',
                'no_signal': '#666666'
            };
            return colors[quality] || '#00ff00';
        }

        // === CONTINUƒÇ CU RESTUL FUNC»öIILOR ===

        // Deconectare
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentDoctor');
            authToken = null;
            currentDoctor = {};
            selectedPatientId = null;
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            if (ecgAnimation) {
                cancelAnimationFrame(ecgAnimation);
            }
            
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('patient-values').classList.remove('active');
            showMessage('A»õi fost deconectat din portal.', 'success');
        }

        // Porne»ôte monitorizarea automatƒÉ
        function startMonitoring() {
            console.log('Pornire monitorizare...');
            
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updatePatientsStatus();
            
            updateInterval = setInterval(() => {
                console.log('Actualizare automatƒÉ...');
                updatePatientsStatus();
            }, 5000);
        }

        // Actualizare statusuri pacien»õi
        async function updatePatientsStatus() {
            if (!isApiConnected) return;
            
            try {
                const patientElements = document.querySelectorAll('.patient-item');
                
                for (let element of patientElements) {
                    const alertElement = element.querySelector('.alert-indicator');
                    const patientId = alertElement.id.replace('alert-', '');
                    
                    const measurements = await getPatientMeasurementsPHP(patientId);
                    updatePatientAlert(patientId, measurements);
                    
                    if (selectedPatientId == patientId) {
                        updateSelectedPatientValues(measurements);
                    }
                }
                
                document.getElementById('last-update').textContent = new Date().toLocaleString('ro-RO');
            } catch (error) {
                console.error('Eroare la actualizarea statusului:', error);
            }
        }

        // Actualizare bulinu»õƒÉ alertƒÉ pentru un pacient
        function updatePatientAlert(patientId, measurements) {
            const alertElement = document.getElementById(`alert-${patientId}`);
            if (!alertElement) return;

            if (measurements.temperatura === '--' || measurements.temperatura === 'Eroare') {
                alertElement.className = 'alert-indicator alert-offline';
                return;
            }

            const temp = parseFloat(measurements.temperatura);
            const puls = parseInt(measurements.puls);
            const umiditate = parseInt(measurements.umiditate || 0);

            let alertType = 'normal';
            
            if (temp > 26.0 || temp < 22.0 || puls > 120 || puls < 50 || umiditate < 35) {
                alertType = 'critical';
            } else if (temp > 25.0 || temp < 23.0 || puls > 100 || puls < 60 || umiditate < 40) {
                alertType = 'warning';
            }

            alertElement.className = `alert-indicator alert-${alertType}`;
        }

        // Actualizare valori pentru pacientul selectat
        function updateSelectedPatientValues(measurements) {
            // ActualizeazƒÉ valorile de bazƒÉ
            document.getElementById('temp-value').textContent = measurements.temperatura === '--' || measurements.temperatura === 'Eroare' ? measurements.temperatura : `${measurements.temperatura}¬∞C`;
            document.getElementById('pulse-value').textContent = measurements.puls === '--' || measurements.puls === 'Eroare' ? measurements.puls : `${measurements.puls} BPM`;
            document.getElementById('oxygen-value').textContent = measurements.umiditate === '--' || measurements.umiditate === 'Eroare' ? measurements.umiditate : `${measurements.umiditate}%`;
            
            // SchimbƒÉ eticheta pentru claritate
            document.querySelector('.value-item:nth-child(3) .value-label').textContent = 'Umiditate (%)';

            // ActualizeazƒÉ statusurile
            if (measurements.temperatura !== '--' && measurements.temperatura !== 'Eroare') {
                const temp = parseFloat(measurements.temperatura);
                const puls = parseInt(measurements.puls);
                const umiditate = parseInt(measurements.umiditate);

                updateValueStatus('temp', temp, [23.0, 25.0], [22.0, 26.0]);
                updateValueStatus('pulse', puls, [60, 100], [50, 120]);
                updateValueStatus('oxygen', umiditate, [40, 50], [35, 55]);

                // ActualizeazƒÉ ECG cu valorile reale - asta e partea principalƒÉ √ÆmbunƒÉtƒÉ»õitƒÉ!
                const ecgValue = parseFloat(measurements.ecg);
                updateECGStatus(ecgValue, puls);
            } else {
                // MarcheazƒÉ ca indisponibil
                ['temp', 'pulse', 'oxygen', 'ecg'].forEach(prefix => {
                    const statusElement = document.getElementById(`${prefix}-status`);
                    if (statusElement) {
                        statusElement.textContent = 'N/A';
                        statusElement.className = 'value-status status-normal';
                    }
                });
            }
        }

        // Actualizare status ECG bazat pe date reale
        function updateECGStatus(ecgValue, pulseValue) {
            const statusElement = document.getElementById('ecg-status');
            
            if (ecgValue === 0 || isNaN(ecgValue)) {
                statusElement.textContent = 'No Signal';
                statusElement.className = 'value-status status-critical';
            } else if (ecgValue < 1.0 || ecgValue > 4.0) {
                statusElement.textContent = 'Abnormal Range';
                statusElement.className = 'value-status status-warning';
            } else if (pulseValue < 60 || pulseValue > 100) {
                statusElement.textContent = 'Rhythm Issue';
                statusElement.className = 'value-status status-warning';
            } else {
                statusElement.textContent = 'Normal';
                statusElement.className = 'value-status status-normal';
            }
        }

        // Actualizare status pentru o valoare specificƒÉ
        function updateValueStatus(prefix, value, normalRange, criticalRange) {
            const statusElement = document.getElementById(`${prefix}-status`);
            
            if (value < criticalRange[0] || value > criticalRange[1]) {
                statusElement.textContent = 'CRITIC';
                statusElement.className = 'value-status status-critical';
            } else if (value < normalRange[0] || value > normalRange[1]) {
                statusElement.textContent = 'Aten»õie';
                statusElement.className = 'value-status status-warning';
            } else {
                statusElement.textContent = 'Normal';
                statusElement.className = 'value-status status-normal';
            }
        }

        // Mod demonstra»õie - dezactivat
        function demoMode() {
            showMessage('Modul demonstra»õie a fost dezactivat. Aplica»õia folose»ôte doar date reale din baza de date MySQL.', 'info');
        }

        // === FUNC»öII HELPER PENTRU ECG ===

        // AnalizeazƒÉ istoricul ECG pentru tendin»õe
        function analyzeECGHistory(allMeasurements) {
            if (!allMeasurements || allMeasurements.length < 2) {
                return {
                    trend: 'insufficient_data',
                    variability: 0,
                    average: 0
                };
            }

            const ecgValues = allMeasurements.map(m => parseFloat(m.ecg)).filter(v => !isNaN(v));
            
            if (ecgValues.length === 0) {
                return { trend: 'no_data', variability: 0, average: 0 };
            }

            const average = ecgValues.reduce((a, b) => a + b, 0) / ecgValues.length;
            const variance = ecgValues.reduce((sum, val) => sum + Math.pow(val - average, 2), 0) / ecgValues.length;
            const variability = Math.sqrt(variance);

            // DeterminƒÉ tendin»õa
            let trend = 'stable';
            if (ecgValues.length >= 3) {
                const recent = ecgValues.slice(-3);
                const older = ecgValues.slice(-6, -3);
                
                if (older.length > 0) {
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
                    
                    if (recentAvg > olderAvg * 1.1) trend = 'increasing';
                    else if (recentAvg < olderAvg * 0.9) trend = 'decreasing';
                }
            }

            return { trend, variability, average };
        }

        // DetecteazƒÉ anomalii ECG
        function detectECGAnomalies(currentValue, historicalData) {
            if (!historicalData || historicalData.length < 5) {
                return { hasAnomaly: false, type: 'insufficient_data' };
            }

            const analysis = analyzeECGHistory(historicalData);
            
            // VerificƒÉ dacƒÉ valoarea curentƒÉ e √Æn afara intervalului normal
            const threshold = analysis.average + (2 * analysis.variability);
            const lowerThreshold = analysis.average - (2 * analysis.variability);
            
            if (currentValue > threshold) {
                return { hasAnomaly: true, type: 'spike', severity: 'high' };
            } else if (currentValue < lowerThreshold) {
                return { hasAnomaly: true, type: 'drop', severity: 'high' };
            } else if (analysis.variability > 1.0) {
                return { hasAnomaly: true, type: 'irregular', severity: 'medium' };
            }
            
            return { hasAnomaly: false, type: 'normal' };
        }

        // GenereazƒÉ raport ECG
        function generateECGReport(patientId) {
            if (!lastECGData) {
                return 'Nu sunt date ECG disponibile pentru acest pacient.';
            }

            const analysis = analyzeECGHistory([lastECGData.measurement]);
            const anomaly = detectECGAnomalies(lastECGData.rawValue, [lastECGData.measurement]);
            
            let report = `
üìã RAPORT ECG - Pacient ID: ${patientId}
========================================
üïê Timestamp: ${lastECGData.timestamp}
üìä Valoare curentƒÉ: ${lastECGData.rawValue.toFixed(3)}V
üíì Ritm cardiac: ${lastECGData.pulse} BPM
üîÑ Status: ${anomaly.hasAnomaly ? 'ANOMALIE DETECTATƒÇ' : 'NORMAL'}
üìà Tendin»õƒÉ: ${analysis.trend}
‚ö†Ô∏è  Variabilitate: ${analysis.variability.toFixed(3)}

${anomaly.hasAnomaly ? `üö® ALERTƒÇ: ${anomaly.type} (${anomaly.severity})` : '‚úÖ Valori √Æn parametri normali'}
            `.trim();

            console.log(report);
            return report;
        }

        // ExportƒÉ date ECG pentru analizƒÉ externƒÉ
        function exportECGData() {
            if (!lastECGData) {
                showMessage('Nu sunt date ECG disponibile pentru export.', 'error');
                return;
            }

            const exportData = {
                patient_id: selectedPatientId,
                timestamp: new Date().toISOString(),
                ecg_data: {
                    raw_value: lastECGData.rawValue,
                    pulse: lastECGData.pulse,
                    rhythm: determineECGRhythm(lastECGData.rawValue, lastECGData.pulse),
                    quality: determineSignalQuality()
                },
                buffer_data: ecgDataBuffer.slice(-100), // Ultimele 100 de puncte
                analysis: analyzeECGHistory([lastECGData.measurement])
            };

            // CreeazƒÉ »ôi descarcƒÉ fi»ôierul JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ECG_Data_Patient_${selectedPatientId}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showMessage('Date ECG exportate cu succes!', 'success');
        }

        // Func»õie pentru debugging - afi»ôeazƒÉ toate datele ECG
        function debugECGData() {
            if (!lastECGData) {
                console.log('‚ùå Nu sunt date ECG disponibile pentru debugging');
                return;
            }

            console.log('üîç DEBUG ECG DATA:');
            console.log('==================');
            console.log('üìä Raw Value:', lastECGData.rawValue);
            console.log('üíì Pulse:', lastECGData.pulse);
            console.log('üïê Timestamp:', lastECGData.timestamp);
            console.log('üìà Buffer Length:', ecgDataBuffer.length);
            console.log('üéØ Mode:', ecgMode);
            console.log('üîÑ Update Count:', ecgUpdateCount);
            console.log('üìã Full Measurement:', lastECGData.measurement);
            
            // Afi»ôeazƒÉ »ôi √Æn interfa»õƒÉ
            const report = generateECGReport(selectedPatientId);
            showMessage(`Debug complet ECG:\n${report}`, 'info');
        }

        // AdaugƒÉ event listeners pentru debugging (optional)
        document.addEventListener('keydown', function(event) {
            // Ctrl + D pentru debug ECG
            if (event.ctrlKey && event.key === 'd') {
                event.preventDefault();
                debugECGData();
            }
            
            // Ctrl + E pentru export ECG
            if (event.ctrlKey && event.key === 'e') {
                event.preventDefault();
                exportECGData();
            }
        });

        // Afi»ôeazƒÉ comenzile de debugging √Æn consolƒÉ
        console.log('üîß ECG DEBUG COMMANDS:');
        console.log('- Ctrl+D: Debug ECG Data');
        console.log('- Ctrl+E: Export ECG Data');
        console.log('- debugECGData(): Manual debug');
        console.log('- exportECGData(): Manual export');
        console.log('- generateECGReport(patientId): Generate report');
    </script>
</body>
</html>
